# .gitlab-ci.yml for Job Application Management System
# CI/CD pipeline configuration

stages:
  - build
  - test
  - security
  - package
  - deploy

variables:
  APP_NAME: "job-app"
  APP_VERSION: "1.0.0"

############################################
# STAGE 1: BUILD
############################################
build-job:
  stage: build
  image: node:18
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Checking syntax errors..."
    - node -c app.js
    - node -c job.js
    - echo "Build completed successfully!"
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

############################################
# STAGE 2: TEST
############################################
test-job:
  stage: test
  image: node:18
  # Remove the dependencies: [build-job] line if you want a fresh start
  script:
    - echo "Installing fresh dependencies for Linux environment..."
    - npm install
    - echo "Running unit tests..."
    - npm test
    - echo "All tests passed!"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

############################################
# STAGE 3: SECURITY
############################################
security-secrets-scan:
  stage: security
  image: zricethezav/gitleaks:latest
  script:
    - echo "Scanning for secrets..."
    - gitleaks detect --source=. --verbose --no-git
    - echo "No secrets detected!"
  allow_failure: false

security-dependencies-scan:
  stage: security
  image: node:18
  script:
    - echo "Checking for vulnerabilities in dependencies..."
    - npm audit --audit-level=high
    - echo "No critical vulnerabilities detected!"
  allow_failure: false

############################################
# STAGE 4: PACKAGE
############################################
package-docker:
  stage: package
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Building Docker image..."
    - docker build -t $APP_NAME:$APP_VERSION .
    - docker build -t $APP_NAME:latest .
    - echo "Docker image built successfully!"
    - docker images
  only:
    - main

############################################
# STAGE 5: DEPLOY
############################################
deploy-staging:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Deploying to staging environment..."
    - echo "Stopping old version if exists..."
    - docker stop job-app-staging || true
    - docker rm job-app-staging || true
    - echo "Starting new version..."
    - docker run -d --name job-app-staging -p 3000:3000 $APP_NAME:$APP_VERSION
    - echo "Application deployed to staging!"
  environment:
    name: staging
    url: http://staging.job-app.local:3000
  only:
    - main

deploy-production:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Deploying to PRODUCTION..."
    - echo "Stopping old version..."
    - docker stop job-app-prod || true
    - docker rm job-app-prod || true
    - echo "Starting new version..."
    - docker run -d --name job-app-prod -p 8080:3000 $APP_NAME:$APP_VERSION
    - echo "Application deployed to PRODUCTION!"
  environment:
    name: production
    url: http://www.job-app.com
  when: manual
  only:
    - main
